
\chapter{Modelling of electromagnetic fields}

\label{ch:Modelling}In principle almost all processes occurring in
the fields of molecular and atomic physics can be reduced to electromagnetic
interaction of elementary particles. However, for the purpose of this
chapter we limit our discussion only to large scale electrostatic
and magnetostatic fields. These are determined in the experiment by
applied potentials to the electrodes, currents in the electromagnets,
and spatial distribution of charged particles in case of plasmatic
experiments. Proper understanding of large scale electromagnetic fields
is essential for any experiment involving charged particles, because these fields
consequently determine the spatial and energetic distributions of the studied
particles. In this
section, we explain our use of numerical models to obtain magnetic
and electric fields as a solution to Maxwell's equations

\begin{subequations}
\begin{align}
\nabla\cdot\mathbold{D} & =  \rho & \text{Gauss's law,}
\label{eq:sim:gauss}\\
\nabla\cdot\mathbold{B} & =  0 &\text{no monopoles,}
\label{eq:sim:nomono}\\
\nabla\times\mathbold{E} & =  \frac{\partial\mathbold{B}}{\partial t} 
&\text{Faraday's law,}
\label{eq:sim:faraday}\\
\nabla\times\mathbold{H} & =  \mathbold{J}+\frac{\partial\mathbold{D}}{\partial t}
&\text{Amp\`ere's law,}
\label{eq:sim:ampere}
\end{align}
\label{eq:sim:maxwell}
\end{subequations}
in combination with material relations
\begin{equation}
\mathbold{D}=\epsilon\mathbold{E},\;\mathbold{H}=\mathbold{B}/\mu,\;\mathbold{J}=\sigma\mathbold{E}\text{.}
\label{eq:sim:materials}
\end{equation}
\comment{Define the symbols, use acronym package}
In the case of static fields, the time derivatives can be neglected.
In our experimental setups, the electrostatic field is completely
determined by the electrode potentials and space charge densities
inside the vacuum vessel. Influence of induced currents on the magnetic
field is negligible in comparison with the external magnetic field
generated by electromagnets. Hence, the electrostatic and magnetostatic
fields are not coupled in any way. The separate treatment of electric
and magnetic fields will be presented in the next sections. 

Please note, that we do not discuss complete mathematical foundations of the involved numerical methods. Only the principles and the 
information necessary to implement these methods with help of
freely available libraries are presented. For detailed discussion refer to textbooks on
computational physics or plasma modelling \eg\ \cite{fenicsbook,bossavit1998,birdsall1991,hockney1988}.


\section{Electrostatic fields}

The governing equation for electrostatic field is the Poisson
equation. Since we are interested in the field in vacuum, we can substitute
for $\mathbold{D}$ from the material equation (\ref{eq:sim:materials}). Then using the relation for the scalar potential $\mb E = -\nabla \phi$ we obtain
\begin{equation}
\Delta\phi=-\frac{\rho}{\epsilon_{0}}\;;\quad \mb r\in\Omega\text{.}
\end{equation}
\comment{define $\mb r$ somewhere}
Now in order to solve for the potential $\phi$ in certain domain $\Omega$, we need to specify the
charge density $\rho$ in this domain and the boundary conditions (Dirichlet, Neumann, or mixed)
on the domain boundary $\partial\Omega$. In our calculations, we deal only with Dirichlet boundary
conditions, \ie
\begin{equation}
\phi=\phi_{0}\;;\quad \mb r\in\Omega\text{.}
\end{equation}

\subsection{Finite difference method}
Probably the simplest approach to solving this kind of problem is the \ac{FDM}.
Said method replaces the continuous functions by functions defined on a discrete set of points and
the differential operators are replaced by finite differences operating on these points.
In particular, in Cartesian coordinates we use the central differences with second order accuracy 
($O(\Delta x^2)$)
\begin{equation}
\frac{\partial f_i}{\partial x} \approx \frac{f_{i+1/2} - f_{i-1/2}}{\Delta x}\;,\qquad
\frac{\partial^2 f_i}{\partial x^2} \approx \frac{f_{i-1} - 2f_i + f_{i+1}}{\Delta x^2}\;.
\end{equation}
In the above equation, a standard nomenclature for expressing difference equations is used, \ie\ 
$f_j \equiv f(x_j);\; x_j \equiv j\Delta x$, where $\Delta x$ is the spacing between grid points.
We assume the simple case of homogeneous grid, \ie\ $\Delta x = \text{const.}$.

The Poisson equation on a homogeneous isotropic two-dimensional Cartesian grid ($\Delta x = \Delta y = \text{const.}$) can thus
be converted into a set of linear equations of the form
\begin{equation}
\frac{4\phi_{ij} - \phi_{i-1,j} - \phi_{i+1,j} - \phi_{i,j-1} - \phi_{i,j+1}}
    {\Delta x^2} = \frac{\rho_{ij}}{\epsilon_0}\;;\quad \mb r_{ij} \in \Omega\setminus\partial\Omega\text,
\label{eq_sim_poiscart}
\end{equation}
where we define the position vector as $\mb r_{ij} = (x_{ij}, y_{ij})$.
In combination with Dirichlet boundary conditions
\begin{equation}
\phi_{ij} = \phi^0_{ij}\;;\quad \mb r_{ij} \in \partial\Omega\text,
\label{eq_sim_boundary}
\end{equation}
these equations fully determine the desired solution.

The situation is more complicated in case of non-Cartesian grids. It is,
however useful to use curvilinear coordinate systems that can accommodate to the symmetry of the studied problem.
In our experiments we often deal with cylindrically symmetric situation and therefore we implement a solver of Poisson equation in the 2-dimensional
$r$-$z$ cylindrical coordinates.
The discretization of the Laplace operator
in cylindrical coordinates using the Gauss' law is described in the section 14-10 of \cite{birdsall1991}.
The radial part for the case of homogeneous grid spacing in the radial direction can be written as
\begin{equation}
\Delta_r\phi\approx
\begin{cases}
    \displaystyle\frac{(i-1/2)\phi_{i-1} - 2i\phi_{i} + (i+1/2)\phi_{i+1}}
    {i\Delta r^2} & r_{i} \in \Omega\setminus\partial\Omega; i\neq0\\
    \displaystyle\frac{\phi_{1} - \phi_{0}}
    {\Delta r^2} & i=0\text.
\end{cases}
\end{equation}
The axial part of the Laplace operator is the same as in the Cartesian
coordinates. By summing the axial and radial parts, we can obtain the discrete approximation for the
Laplace operator in $r$-$z$ coordinates and the Poisson equation then reads
\begin{subequations}
\begin{multline}
\frac{\rho_{ij}}{\epsilon_0} = 
    -\frac{(i-1/2)\phi_{i-1,j} - 2i\phi_{ij} + (i+1/2)\phi_{i+1,j}}
    {i\Delta r^2}\\
    -\frac{\phi_{i,j-1} - 2\phi_{ij} + \phi_{i,j+1}}
    {\Delta z^2}\,;\quad\hfill
 r_{ij} \in \Omega\setminus\partial\Omega; i\neq0,\\
\end{multline}
\begin{multline}
\frac{\rho_{ij}}{\epsilon_0} = 
    -\frac{\phi_{1,j} - \phi_{0,j}}
    {\Delta r^2}
    -\frac{\phi_{i,j-1} - 2\phi_{ij} + \phi_{i,j+1}}
    {\Delta z^2}\,;\quad\hfill
 r_{ij} \in \Omega\setminus\partial\Omega; i=0.\\
\end{multline}
\end{subequations}

One of the most powerful methods for solving the finite differenced Poisson equation is based on the
{\em LU decomposition} \citep{pekarek2007ipm}. To explain the principle of this method, assume that
the set of equations (\ref{eq_sim_poiscart}), (\ref{eq_sim_boundary}) is written in the matrix form
\begin{equation}
\mb A\mb\phi = \mb\rho\,.
\label{eq:sim:matrix}
\end{equation}
\comment{Does this need further explanation? The vector $\mb\rho$ contains elements from $\rho_{ij}$
and $\phi_{ij}$, so perhaps a different name should be chosen?} The square matrix $\mb A$ has order $n$
and can be decomposed into an upper triangular matrix $\mb U$ and a lower triangular matrix $\mb L$, \ie\ $\mb A=\mb L\mb U$.
Using this LU decomposition, we can rewrite equation (\ref{eq:sim:matrix}) into a system of equations
\begin{subequations}
\label{eq:sim:LUset}
\begin{eqnarray}
\mb U\mb\phi &=& \mb x\\
\mb L\mb x &=& \mb \rho\,,
\end{eqnarray}
\end{subequations}
which can be solved easily using backsubstitution thanks to the triangular shape of $\mb L$ and $\mb U$.
The most complicated step in this solution procedure is (as could be expected) the calculation
of the LU decomposition, which has algorithmic complexity $O(n^3)$ for general and practically useful algorithms. Despite
the complexity of the decomposition, this procedure is very useful for selfconsistent simulations
of plasmas, since the decomposition needs to be calculated only once for the given geometry. The
solutions for various combinations of charge densities and boundary conditions can then be
obtained very
quickly by varying the right hand side vector $\mb \rho$ in equations (\ref{eq:sim:LUset}).

In this work we use the freely available library \ac{UMFPACK} \citep{umfpack}. The UMFPACK
decomposition algorithms are optimized for dealing with sparse matrices, so they can take advantage
of the sparse structure of matrix $\mb A$, which is essential for performing this calculation
with large matrices on personal computers.
Typical mesh sizes used in our calculations are of the order $200\times200$,
therefore the matrix $\mb A$ is typically of the order $40\,000$ and contains $1.6\cdot10^9$ elements,
of which only about $200\,000$ elements are nonzero.
Since only the nonzero elements need to be stored, this matrix is easily calculated and stored in the
memory of a personal computer.
The LU decomposition of a sparse matrix is not sparse in general.
However, the UMFPACK library can ensure by preordering of the matrix $\mb A$ optimal sparsity and accuracy
of the LU decomposition.
For details of the UMFPACK algorithm see \citep{davis2004,davis1999}.

The finite difference methods offer a relatively simple and efficient solution
for dealing with partial differential equations on simple geometries.
However, it becomes very difficult to accommodate the regular mesh
and difference equations to
the complicated geometries of many real experiments.
Therefore, the complementary \ac{FEM} is used in
most cases with irregular geometry.

\subsection{Finite element method}
The finite element method approaches the solution by converting the
\ac{PDE} into a variational problem called the {\em weak formulation}.
This procedure generally consists of multiplying the equation by a test function
$v$ and integrating over the domain $\Omega$. For Poisson equation we thus obtain using the
Green's identity (integration by parts)
\begin{equation}
\int_\Omega \nabla\phi\cdot\nabla v\de\mb r = \int_\Omega\frac{\rho}{\epsilon_0}v\de\mb r\,.
\label{eq:sim:weak}
\end{equation}
We drop the boundary integral, because we choose test functions equal zero on the Dirichlet boundary,
where $\phi$ is known. Solving Poisson equation is now equivalent to finding $\phi\in V$ such
that equation \eqref{eq:sim:weak} is satisfied for all $v\in \hat V$.
The test space $\hat V$ is defined as
\begin{equation}
\hat V = \{v\in H^1(\Omega) : v=0\ \text{on}\ \partial\Omega\}\,,
\end{equation}
and we are looking for $\phi$ in a trial space $V$, which automatically satisfies the Dirichlet
boundary condition
\begin{equation}
V = \{v\in H^1(\Omega) : v=\phi_0\ \text{on}\ \partial\Omega\}\,.
\end{equation}
Symbol $H^1(\Omega)$, denotes a Sobolev space of functions $v$ defined as $H^1(\Omega) = \{v\in L^2(\Omega); |\nabla v|^2 \in L^2(\Omega)\}$.

In order to solve this infinitely dimensional problem numerically, we have to restrict the
functions to some finitely dimensional subspaces $V_h \subset V$ and $\hat V_h\subset\hat V$ with
dimension $N$. In particular, the finite element method uses a basis consisting of piecewise
polynomial functions with ``small support''. The basis functions are defined in relation
to a certain discrete mesh and are called {\em finite elements}, hence the name finite element
method. For more information on various finite elements, see \eg\ \citep{fenicsbook}
\comment{I have to find the other reference}.
Assuming that the bases for our problem are defined by
 $\{v_k\}_{k=1}^N$ and $\{\hat v_k\}_{k=1}^N$, then the approximate
solution $\phi_h \in V_h$ can be written as
\begin{equation}
\phi_h = \sum_{k=1}^N U_k v_k\,.
\end{equation}
The values of coefficients are obtained by solving equation \eqref{eq:sim:weak} for all the
basis functions from the test space $\hat V_h$, \ie
\begin{equation}
\sum_{k=1}^N U_k\int_\Omega \nabla v_k\cdot\nabla \hat v_l\de\mb r =
 \int_\Omega\frac{\rho}{\epsilon_0} \hat v_l \de\mb r\,;\quad l=1,2,\ldots,N\,.
\end{equation}
This set of linear equations has a sparse matrix in the matrix formulation and can be solved
by the same methods as the finite difference equations.

\subsection{Implementation of finite element method}

\section{Magnetostatic fields}
Similarly to the electrostatic field, also the Maxwell's equations for the
magnetostatic field can be converted into a single second order equation
using a potential formulation. From equation \eqref{eq:sim:nomono} we
see, using the Helmholtz decomposition, that $\mb B$ can be expressed
as $\mb B = \nabla\times\mb A$. The Amp\`ere's law \eqref{eq:sim:ampere}
then reads
\begin{equation}
\nabla\times\frac{1}{\mu}\nabla\times\mb A = \mb J\text{.}
\end{equation}
In combination with known current density $\mb J$ and magnetic
permitivity $\mu$ in domain $\Omega$ and with boundary contitions
for $\mb B$ on $\partial\Omega$,
the Amp\'ere's law specifies the magnetic field $\mb B$. However,
the vector potential is specified only up to a non-rotational
component $\nabla\psi$. Therefore, we have to add additional
gauge equation to make the problem well posed. We use the
Coulomb gauge
\begin{equation}
\nabla\cdot\mb A = 0\,,
\end{equation}
to remove the ambiguity.
Now, following the standard method for deriving the weak formulation,
we multiply the equation by a test function $\mb v$ and perform
integration by parts to obtain
\begin{equation}
\int_\Omega\frac{1}{\mu}\nabla\times\mb A\cdot \nabla\times\mb v\de \mb r
= \int_\Omega \mb J\cdot\mb v\de\mb r\,.
\end{equation}
In order to introduce the gauge condition, we reformulate the problem
as: find such $\mb A\in V$ and $p\in Q$ that equations
\begin{subequations}
\label{eq:sim:curlcurl}
\begin{equation}
\int_\Omega\frac{1}{\mu}\nabla\times\mb A\cdot \nabla\times\mb v\de \mb r
+ \int_\Omega v\cdot\nabla p\de\mb r
= \int_\Omega \mb J\cdot\mb v\de\mb r\,,
\end{equation}
\begin{equation}
\int_\Omega \mb A\cdot\nabla q\de\mb r =0\,,
\end{equation}
\end{subequations}
hold for all $\mb v\in \hat V$, $q\in \hat Q$. The trial and test spaces
are defined as
$V = \hat V = \{ \mb v\in H(\curl,\Omega): \mb v = (0,0,0)\  \text{on}\ \partial \Omega\}$  and
$Q = \hat Q = \{ q\in H^1(\Omega): q = 0\  \text{on}\ \partial \Omega\}$. 
The symbol $H(\curl,\Omega)$, denotes a Sobolev space of functions
$\mb v$ defined as $H(\curl,\Omega) = \{\mb v\in L^2(\Omega); |\nabla\times\mb v|^2 \in L^2(\Omega)\}$.
Equations \eqref{eq:sim:curlcurl} can be understood as a constrained
optimization of the magnetic field energy functional using the method
of Lagrange multipliers. However, for a proper discussion in relation
to the finite element method, see \eg\ \citep{haase2001} or lecture notes
by \cite{schoberl2009}.

\subsection{Implementation of finite element method for magnetostatics}
FENiCS
